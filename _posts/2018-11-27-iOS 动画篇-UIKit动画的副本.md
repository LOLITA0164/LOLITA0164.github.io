---
layout:     post
title:      iOS 动画篇 - UIKit动画
subtitle:   UIKit动画
date:       2018-11-27-iOS 
author:     LOLITA0164
header-img: img/post-bg-animation.jpg
catalog: true
tags: 
    - iOS
    - 动画
---


## UIViewAnimating

UIViewAnimating 协议定义了实现动画基本流控制的方法，包括启动，停止和暂停动画的能力。除此之外还有几个属性用于反映动画的当前状态以及在动画进行过程中修改该状态。

通常，我们使用此协议的方法来管理与 UIViewPropertyAnimator 对象关联的动画。 具体来说，可以使用这些方法来启动和停止动画，反转动画以及更改动画的完成进度。 另外，我们可以使用这些功能来实现交互式动画，也可以采用此协议来实现自定义动画对象。

**动画的状态**

在 Animator 对象处理一组动画时，通常会伴随着对应的动画状态。这些状态定义了 Animator 对象的行为，包括它时如何处理变化的。如果你在实现自定义 Animator，必须遵循这些状态的转换并准确的更新状态属性。下图显示了发生的状态和状态的转换关系。

![animator对象的状态转换](https://ws2.sinaimg.cn/large/006tNbRwgy1fxmm4f2ztaj30kq0d5mxd.jpg)

非活动状态是 animator 的初始状态。 每个新创建的 animator 都会在非活动状态下启动。类似地，已完成动画的 animator 返回到非活动状态。处于非活动状态时，我们可以配置要执行的动画，包括持续的时间，对应的变换。

当调用 `-startAnimation` 或 `-pauseAnimation `方法时，animator 会变为活动状态。此状态下的 animator 正在运行其动画或暂停，此时我们还可以修改这些动画。当当前动画运行到其预期结束时，animator 返回到非活动状态，此时我们可以使用一组新动画重新配置它，以便开始新的动画。

调用 `stopAnimation` 方法会停止所有正在运行的动画，并将相应视图的属性更新为其当前正在进行的值。调用此方法后，动画对象将移至停止或非活动状态，必须重新配置才能再次使用。

**协议内容**

**操作动画**

`-startAnimation`：开始动画

调用此方法可以启动动画或在暂停动画后恢复动画。 此方法将 animator 的状态设置为 UIViewAnimatingStateActive（如果尚未存在）。 在 animator 的状态设置为 UIViewAnimatingStateStopped 时调用此方法方法时会发生错误。

`-startAnimationAfterDelay:`：在指定延迟后开始动画。

`-pauseAnimation`：暂停动画

在非活动 animator 上调用此方法会将其状态移至 UIViewAnimatingStateActive 并立即将其动画置于暂停状态。 要恢复动画，请调用 startAnimation 方法。 如果动画已暂停，则此方法不应执行任何操作。 在 animator 的状态设置为 UIViewAnimatingStateStopped 时调用此方法时会发生错误。

`-stopAnimation:`：停止动画

参数withoutFinishing，指示是否应执行任何最终操作。指定 YES 会清除任何动画并将 animator 直接移动到 UIViewAnimatingStateInactive 状态，而不执行任何最终操作。指定 NO 以将 animator 置于 UIViewAnimatingStateStopped 状态。

如果为 withoutFinishing 参数指定 NO ，则可以随后调用`finishAnimationAtPosition：`方法来执行 animator 的最终操作（将执行其完成块的内容）。不过也不是必须要立即调用 `finishAnimationAtPosition：` 方法，你可以在调用该方法之前执行其他动画。

`-finishAnimationAtPosition:`：完成动画并将 animator 返回到非活动状态，执行完成块。

三种动画位置：UIViewAnimatingPosition

```
UIViewAnimatingPositionEnd		//动画的终点
UIViewAnimatingPositionStart	//动画的开头
UIViewAnimatingPositionCurrent//动画当前位置
```

任何视图属性的最终位置。指定 UIViewAnimatingPositionCurrent 以使视图属性与其当前值保持不变。除非在调用`stopAnimation：`方法参数传递 NO ，否则在任何时候调用此方法都是发生错误。

**一些属性**

`fractionComplete`：动画的完成百分比

此属性的值在动画开始时为0.0，在动画结束时为1.0。中间值表示动画执行的进度。 例如，值0.5表示动画正好完成了一半。

为此属性指定新值会使 animator 将动画进度更新为指定的值。我们可以使用此功能创建交互式动画。例如，使用平移手势识别器根据该手势的完成进度更新值。注：只有在animator 暂停时才能更新此属性的值。在非活动动画师上更改此属性的值会将其移动到活动状态。

定义自定义动画制作工具时，如果支持动画超过其起点或终点，则可以允许大于1.0或小于0.0的值。

`reversed`：是否执行反向动画

`state`：当前动画状态

三种动画状态：UIViewAnimatingState

```
UIViewAnimatingStateInactive	// 非活动状态
UIViewAnimatingStateActive	// 活动状态
UIViewAnimatingStateStopped	// 停止状态
```

`running`：当前动画似否正在执行，支持 KVO

只有在调用`startAnimation`方法后，此属性的值才为 YES。当 animator 暂停或停止时，该值为 NO。


## UIViewImplicitlyAnimating

UIViewImplicitlyAnimating 继承自 UIViewAnimating 协议，拥有其启动，停止和暂停动画的能力，除此之外，UIViewImplicitlyAnimating 还新增了几种可以修改动画的动画块、完成块，甚至是暂停的动画的执行时间和速度。

UIViewPropertyAnimator 这个动画器就是采用了此协议并且实现了其所有的方法，因此我们可以使用 UIViewPropertyAnimator 创建实例，完成精确的视图的动画控制。我们可以在自定义类中采用了此协议来实现自定义动画对象，并且需要实现所有的方法。

**修改动画**

- `-addAnimations:`：添加动画块

使用此方法将新动画块添加到自定义动画对象。指定块中的动画应与任何先前配置的动画一起运行，从当前时间开始并与任何原始动画同时结束。

- `-addAnimations:delayFactor:`

同上，不过会从指定的延迟开始并与任何原始动画同时结束。

delayFactor:

用于延迟动画开始的因素。该值必须介于0.0和1.0之间。将此值乘以动画剩余持续时间，为实际延迟。例如，如果值0.5和动画制作者的持续时间为2.0，则将动画的开始延迟一秒。

- `-addCompletion:`：添加动画完成块

如果调用`stopAnimation：`方法，如果该方法的 withoutFinishing 参数包含值 YES，则不执行任何完成块。如果参数为 NO 并且后续调用`finishAnimationAtPosition：`方法，则在该方法的实现中执行完成块。

- `-continueAnimationWithTimingParameters:durationFactor:`：调整暂停的动画的最终时间和持续时间

`parameters：`参数是要应用于动画的速度信息，有以下两种供你选择：

```
UICubicTimingParameters
UISpringTimingParameters
```
`durationFactor：`参数是应用于动画原始持续时间的倍增因子。将此值乘以动画的原始持续时间值，作为新的持续时间。



## UIViewPropertyAnimator

UIViewPropertyAnimator 对象允许我们对视图进行动画处理，并在动画完成之前动态修改它们。使用 animator，我们可以从头到尾正常运行动画，或者将它们转换为交互式动画并自行控制时间。animator 对视图的可动画属性进行操作，例如 frame，center，alpha 和 transform，并在动画块中完成动画操作。

当我们创建一个 animator 时，确保下面几个东西：

- 包含修改一个或多个视图属性的代码的块
- 用于定义动画运行过程中的速度曲线
- 动画的持续时间（以秒为单位）
- 动画完成时执行的完成块（可选）

在动画块中，将可动画的属性的值设置我们预期的新值。例如，如果要淡出视图，则应在块中将其 alpha 属性设置为0。

属性值更改的速度由创建 animator 时指定的时序曲线控制。 animator 包括对内置 UIKit 动画曲线的支持，如线性 linear，缓入 ease-in 和缓出 ease-out。如果这些都不足以满足需求，我们还可以使用三次贝塞尔曲线或弹簧函数来控制动画的速度曲线。

如果使用标准初始化方法之一创建 animator，则必须通过调用`startAnimation`方法显式启动动画。如果要在创建动画后立即启动动画，请使用`runningPropertyAnimatorWithDuration：delay：options：animations：completion：`方法。

此类采用 UIViewAnimating 和 UIViewImplicitlyAnimating 协议，这些协议定义了启动，停止和修改动画的方法。

**动态的修改动画**

animator 可让我们以编程方式控制动画的计时和执行。具体来说，我们可以完成动画的一下操作：

- 开始，暂停，恢复和停止动画; 
- 在原始动画开始使用`addAnimations：`和`addAnimations：delayFactor：`添加动画块
- 通过修改`fractionComplete`属性来浏览暂停的动画（交互式动画）
- 使用`reverse`属性更改动画的方向
- 通过暂停动画并使用`continueAnimationWithTimingParameters：durationFactor：`方法来完成它，从而修改部分完成动画的时间和持续时间

**一些方法**

**构建方法**

- `-initWithDuration:curve:animations:`：使用内置的 UIKit 速度曲线初始化

curve 的参数有：

```
UIViewAnimationCurveEaseInOut //缓进缓出
UIViewAnimationCurveEaseIn //缓进
UIViewAnimationCurveEaseOut //缓出
UIViewAnimationCurveLinear //线性匀速
```
animations 所对应着包含动画的块，使用此块修改任何可动画的视图属性，下同。

如果所说 UIKit 提供的速度曲线不能够满足你的速度要求，你还可以通过自定义来创建自己的速度曲线。

- `-initWithDuration:controlPoint1:controlPoint2:animations:`：使用三次贝塞尔定时速度曲线初始化，控制点的取值范围是(0,1)。

此方法使用三次定时曲线创建动画对象，该曲线的起点为（0,0）且其终点为（1,1）。  point1 和 point2 参数是定义生成的贝塞尔曲线形状的控制点。曲线的斜率定义了动画在不同时间的速度。斜率表示动画运行得快慢，斜率越大速度越快。 下图显示了一个速度曲线，其中动画快速启动并快速完成，但在中间部分运行得更慢。

![三次贝塞尔定时速度曲线](https://ws3.sinaimg.cn/large/006tNbRwgy1fxmplczrtoj30i80hfaa6.jpg)

- `-initWithDuration:dampingRatio:animations:`：使用基于弹簧的弹性动画初始化

基于弹簧的动画导致属性的值最初加速到其新值，然后围绕该值振荡，直到最终停止在该值上。

初始加速量与属性的起始值和结束值之间的差异成比例。换句话说，起始值和结束值之间的差异越大，初始加速度越大。比率参数确定应用于初始加速度的阻尼量。较低的阻尼值对应于对加速度的较小阻力和在静止之前的更多振荡。较高的阻尼值对应于更大的阻力和更小的振荡。例如，如果想要在不振荡的情况下平滑地减速动画，请指定值1。指定的值越接近0（减少阻尼量），震荡越小，震荡次数越多。

- `-initWithDuration:timingParameters:`：使用自定义计时曲线对象初始化

使用此方法可以使用自定义速度曲线初始化 animator。和前三中不同，此方法初始化动画后，必须在调用动画之前添加一个或多个动画块来完成属性动画。

timingParameters 参数对象必须采用 UITimingCurveProvider 协议，遵循该协议的有 `cubicTimingParameters` 和 `springTimingParameters` 类，你可以创建这两类的实例作为参数。


以上四种方法都需要在设置 animator 后主动调用 `startAnimation` 来启动动画。如果觉得这样子很麻烦，系统还为我们提供了一个快捷的方法。

- `+ runningPropertyAnimatorWithDuration:delay:options:animations:completion:`：创建并返回一个动画对象，该对象会立即开始运行其动画

需要注意的是，该方法中的动画块必须实现，否则会抛出错误。另外，我们可以为此方法创建的 animator 追加动画块，只不过在创建时的动画块中必须有一个或者多个改变可变属性为新值的代码，否则追加的动画块并不会起到效果。


**一些属性**

- `duration`：只读

动画的持续时间，只有在初始化 animator 指定该值，稍后添加的动画仅在剩余的时间内运行。剩余时间由公式（1.0 - fractionComplete）* 持续时间确定。

- `delay`：只读

延迟动画时间，默认值为。如果要为此属性设置值，启动动画时则需要使用`startAnimationAfterDelay：`方法。

- `timingParameters`：只读

描述速度的曲线，和`duration`一样，只有在初始化 animator 指定该值。可以使用此属性稍后获取这些参数。

- `interruptible`

动画中是否可被打断。当此属性的值为 YES 时，我们可以使用`pauseAnimation`和`stopAnimation：`方法来中断动画并进行更改。当此属性的值为 NO 时，在调用`startAnimation`方法后，动画将运行至完成（并且不会中断）。

如果使用 animator 对象来实现可中断的视图控制器转换，则此属性必须为 YES。

- `userInteractionEnabled`

动画中用户是否可交互。默认值为 YES。

当此属性的值为 YES 时，触摸事件将正常传递给视图，否则在动画持续时间内会忽略用户的触摸事件。

- `manualHitTestingEnabled`

动画中点击测试的能力。默认为 NO。

- `scrubsLinearly`

暂停的动画是否使用线性擦除或者使用指定的描述速度的曲线。

- `pausesOnCompletion`

动画完成后是否保持活动状态。默认值为 NO。

当此属性的值为 YES 时，animator 完成后动画后将保持 UIViewAnimatingStateActive 状态，并且不会执行完成块。此时我们可以撤消动画。另外因为未调用完成处理程序，所以我们无法使用 animator 的完成块来确定动画何时完成运行。这时，如果你需要知道动画何时完成，则可以通过 KVO 监听属性 `running` 来确定动画何时结束。当此属性的值为 NO 时，动画完成后，animator 执行完成块，自动转换为 UIViewAnimatingStateInactive 状态，从而结束动画。
































